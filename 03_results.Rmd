# RESULTS {#sec:results}

```{r set, include=FALSE, message = FALSE, warning=FALSE}
knitr::knit_hooks$set(inline=
                        function(x){
                          if(!is.numeric(x)){x
                          }else{prettyNum(round(x,2),
                                         big.mark=",")}})
# knitr::knit_hooks$set(inline=
#                         function(x){
#                           if(!is.numeric(x)){x
#                           }else{ifelse(x<10,as.character(as.english(x)),x)}})
```

```{r load-data}
{surveys <- readRDS("data/surveys.rds")
month <- 12
year <- 2022
  month_abb <- month.abb[month]
  survey_title <- paste(cemore::first_up(as.character(month_abb)), year)
  surveyid = paste0("cemore_", year, tolower(month_abb))
}

# Load previously saved data
# all_effort <- load_effort(year, as.numeric(month), single_survey = F, vessel = "MB") 
# saveRDS(all_effort, "output_cemore/all_effort/all_effort_to_2022_10.rds")
all_effort <- readRDS(paste0("C:/users/keppele/documents/cemore/analysis/cemore_analysis/output_cemore/all_effort/all_effort_to_",year,"_",month, ".rds"))
all_effort_lines <- readRDS(paste0("C:/users/keppele/documents/cemore/analysis/cemore_analysis/output_cemore/all_lines/all_effort_lines_to_",year,"_",month, ".rds")) #%>% 
  # mutate(length_km = as.numeric(st_length(geometry))/1000) %>% 
  # filter(length_km>0)
# or all_effort_lines %<>% mutate(npts=npts(geometry,by_feature=T)) %>% filter(npts>1)
# all_effort_lines <- get_effort_lines(all_effort)
# saveRDS(all_effort_lines, "output_cemore/all_lines/all_effort_lines_to_2022_10.rds")

# all_ap_sf <- load_sightings(year, as.numeric(month), single_survey = F, vessel="MB") 
# saveRDS(all_ap_sf, "output_cemore/all_sgt/all_effort_sgt_to_2022_10.rds")
all_ap_sf <- readRDS("C:/users/keppele/documents/cemore/analysis/cemore_analysis/output_cemore/all_sgt/all_effort_sgt_to_2022_12.rds")
all_ap_sf <- all_ap_sf %>%  # filter(date<"2022-03-01") %>% 
  # readRDS(paste0("output_cemore/all_sgt/all_effort_sgt_to_",year,"_"< , ".rds")) %>%
  rename(Glare90=glare) %>%
  dplyr::mutate(Beaufort = as.numeric(as.character(Beaufort)),
                Clumped_Beaufort = case_when(
                  Beaufort <2 ~ "0-1",
                  Beaufort == 2 ~ "2",
                  Beaufort > 2 ~ "3+"),
                Clumped_Group_Size2 = factor(
                  dplyr::case_when(
                    Group_Size==1 ~ "1",
                    Group_Size==2 ~ "2",
                    Group_Size==3 ~ "3",
                    Group_Size>3 ~ "4+"
                  ), levels=  c("1","2","3","4+")),
                Clumped_Group_Size = factor(
                  dplyr::case_when(
                    Group_Size==1 ~ "1",
                    Group_Size==2 ~ "2",
                    Group_Size>2 ~ "3+"
                  ), levels=  c("1","2","3+")),
                swell=factor(case_when(
                  swell %in% c("Big >2", "Moderate 1-2 m") ~ "Mod-Big",
                  swell == "Low <1 m" ~ "Low",
                  swell == "No swell" ~ "No swell"),
                  levels= c("No swell", "Low", "Mod-Big")),
                Clumped_Swell=factor(case_when(
                  swell %in% c("Mod-Big", "Low") ~ "Swell",
                  swell == "No swell" ~ "No swell"),
                  levels= c("No swell","Swell")),
                Clumped_Swell2=factor(case_when(
                  swell == "Mod-Big" ~ "Mod-Big",
                  swell %in% c("Low", "No swell") ~ "Low-no swell"),
                  levels= c("Low-no swell","Mod-Big")),
                # Visibility=case_when(   # this is now incorporated into get_effort_lines and get_sightings
                #   Visibility == "F" ~ "M",
                #   !Visibility== "F" ~ Visibility
                # ),
                Clumped_Visibility = case_when(
                  Visibility %in% c("G&E", "Moderate") ~ "G/M",
                  Visibility == "P" ~ "P"),
                Clumped_Vis2 = case_when(
                  Visibility == "G&E"~ "G",
                  Visibility %in% c("Moderate", "P") ~ "M/P"),
                Observer = case_when(
                  Observer == "CMcMillan" ~"a",
                  Observer == "EKeppel"~"b",
                  Observer == "LSpaven"~ "c"),
         l_glare = ifelse(Glare90 == "None", NA, l_glare) %>% as.numeric(),
         r_glare = ifelse(Glare90 == "None", NA, r_glare) %>% as.numeric(),
         Glare90 = ifelse(Glare90 == "Severe","Severe","None/Mild"),
         glare_swath = abs(l_glare-r_glare),
         l_glare45 = case_when(
           l_glare <= -45 ~ -45,
           l_glare %in% -45:45 ~ l_glare,
           l_glare > 45 ~ NA
         ),
         r_glare45 = case_when(
           r_glare >=45 ~ 45,
           r_glare %in% -45:45 ~ r_glare,
           r_glare < -45 ~ NA
         ),
         glare_swath45=case_when(
           l_glare45 %in% -45:45 & r_glare45 %in% -45:45 & !l_glare45==r_glare45 ~ abs(l_glare45-r_glare45)),
         # Glare90y = ifelse(!Glare90=="None","y","n"),
         # Glare90 = ifelse(Glare90=="Severe","Severe","Mild/None"),
         glare_swath = ifelse(Glare90=="Severe", glare_swath, 0),
         glare_swath45 = ifelse(Glare90=="Severe",glare_swath45, 0)#,
         # Glare45 = ifelse(l_glare %in% -45:45 | r_glare %in% -45:45, Glare90, "None"),
         # Glare45y = ifelse(Glare45=="None","n","y"),
         # Glare45 = ifelse(Glare45=="Severe","Severe","Mild/None")
         ) %>% 
  mutate(
    # change which season each month belongs to in order to check effect of our season choices on abund
    season = factor(dplyr::case_when(
      month %in% c(1:2,12) ~ "Winter",
      month %in% c(3:5) ~ "Spring",
      month %in% c(6:8) ~ "Summer",
      month %in% c(9:11)  ~ "Fall"
    ), levels = c("Winter", "Spring", "Summer", "Fall")),
    # season = factor(dplyr::case_when(
    #   month %in% c(2:4) ~ "Winter",
    #   month %in% c(5:7) ~ "Spring",
    #   month %in% c(8:10) ~ "Summer",
    #   month %in% c(11:12,1)  ~ "Fall"
    # ), levels = c("Winter", "Spring", "Summer", "Fall")),
    seasonYear = paste0(tolower(season), year),
    seasonYear = factor(seasonYear, levels = unique(seasonYear)),
    
    # Region.Label= Survey,
    # Region.Label= season,
    Region.Label= seasonYear,
    Sample.Label=TransectID,
    object=Sgt_ID)

# examining effect of glare as a portion of the field of view vs. presence/absence
# x <- all_ap_sf %>% dplyr::select(Species,Glare90, l_glare, r_glare, glare_swath, l_glare45, r_glare45, glare_swath45,distance) %>%
#   mutate(binned_swath = round_any(glare_swath, 5, ceiling),
#          binned_swath45 = round_any(glare_swath45, 5,ceiling)) %>%
#   filter(Species %like% "hump")
# plot(x$binned_swath, x$distance)
# plot(x$glare_swath, x$distance)
# plot(x$binned_swath45, x$distance)
# plot(x$glare_swath45, x$distance)

# View(x)
# ggplot() + geom_bar(data=x,mapping=aes(x=binned_swath, y=distance))
# ggplot(data=x, aes(x=binned_swath, y=distance)) +
#   geom_bar(stat="identity") +
#   theme(axis.text.x=element_text(angle=90))

all_ap_sf$Species <-  all_ap_sf$Species %>% 
  as.character() %>% 
  tolower()
all_ap_sf$Species <- gsub(pattern="dall's",replacement="Dall's",all_ap_sf$Species)
all_ap_sf$Species <- gsub(pattern="bigg's",replacement="Bigg's",all_ap_sf$Species)
# unique(all_ap_sf$Species)

all_ap_sf$Species = factor(all_ap_sf$Species, levels = 
                             c("humpback whale",
                               "harbour porpoise",
                               "Dall's porpoise" ,
                               "unknown porpoise",
                               "killer whale - northern resident",
                               "killer whale - southern resident",
                               "killer whale - Bigg's",
                               "killer whale - unknown ecotype",
                               "grey whale",
                               "fin whale",
                               "minke whale"
                             ))

B <- 2937.946 # survey area (Can only) %>% units::set_units(km^2)#km ^2

effort <- all_effort_lines %>% 
  data.frame() %>% 
     # change which season each month belongs to in order to check effect of our season choices on abund
  mutate(season = factor(dplyr::case_when(
      month %in% c(1:2,12) ~ "Winter",
      month %in% c(3:5) ~ "Spring",
      month %in% c(6:8) ~ "Summer",
      month %in% c(9:11)  ~ "Fall"
    ), levels = c("Winter", "Spring", "Summer", "Fall")),
   # mutate(season = factor(dplyr::case_when(
   #    month %in% c(2:4) ~ "Winter",
   #    month %in% c(5:7) ~ "Spring",
   #    month %in% c(8:10) ~ "Summer",
   #    month %in% c(11:12,1)  ~ "Fall"
   # ), levels = c("Winter", "Spring", "Summer", "Fall")),
   seasonYear = paste0(tolower(season), year),
   seasonYear = factor(seasonYear, levels = unique(seasonYear))) %>%
  # unique segment ID's and length for each
  transmute(Sample.Label=TransectID,
            # Region.Label = SurveyID,
            # Region.Label = season,
            Region.Label = seasonYear,
            Effort = st_length(geometry),
            Area=B) %>% 
  group_by(Region.Label,Area,Sample.Label) %>% 
  summarise(Effort=as.numeric(sum(Effort))/1000) %>% ungroup()

summary_all <- survey_summary(single=F)
# x <- summary_all[[2]] %>% filter(Species %in% c("humpback whale", "Dall's porpoise", "harbour porpoise")) %>% 
#   group_by(seasonYear, Species) %>% 
#   summarise(surveys=n(), sightings=sum(number_sightings), indivs = sum(number_individuals))
# y <- summary_all[[3]] %>% group_by(season, year, seasonYear) %>% summarise(surveys=n(),transects = sum(transects), distance_km=sum(distance_km))
# z <- right_join(y,x) %>% dplyr::select(-seasonYear)
# View(z)

# a <- survey_summary(single=F,Year=2023,Month=5)
# write.csv(a[[3]], "output_cemore/survey_effort_summary.csv")

sum_eff <- summary_all[[3]] %>% 
  as.data.frame() %>% 
  mutate(month_name=month.name[month])
# save(all_effort, all_effort_lines, all_ap_sf, effort, summary_all, sum_eff,surveys,year,month,month_abb, survey_title, surveyid, file="tech_rep_data.RData")
# load("tech_rep_data.RData")
```

## LINE-TRANSECT SURVEYS

In total, `r unique(all_effort_lines$SurveyID) %>% length() %>% english::as.english() %>% as.character()` surveys were conducted between September 2020 and `r month.name[all_effort %>% filter(year == max(year)) %>% dplyr::select(month) %>% max(month)]` `r as.character(max(all_effort$year))`, resulting in a total of `r sum(all_effort_lines$length_km) %>% round(digits=0)` km of effort along pre-determined transect lines in Canadian portions of the study area (Figure \@ref(fig:plot-seasonal-track)). Surveys were conducted at least once during all months with the exception of December. On-effort distance covered varied among surveys, from a low of `r sum_eff[which(sum_eff$distance_km==min(sum_eff$distance_km)),]$distance_km` km in `r sum_eff[which(sum_eff$distance_km==min(sum_eff$distance_km)),]$month_name`, `r sum_eff[which(sum_eff$distance_km==min(sum_eff$distance_km)),]$year %>% as.character()`, to a high of `r sum_eff[which(sum_eff$distance_km==max(sum_eff$distance_km)),]$distance_km` km in `r sum_eff[which(sum_eff$distance_km==max(sum_eff$distance_km)),]$month_name`, `r sum_eff[which(sum_eff$distance_km==max(sum_eff$distance_km)),]$year %>% as.character()`. Coverage of the western-most and northern-most transect lines in some months of each season was limited by weather conditions. 

## SPECIES SIGHTINGS AND GENERAL DISTRIBUTION PATTERNS

A total of `r nrow(all_ap_sf)` sightings of five cetacean species (`r sum(all_ap_sf$Group_Size)` individuals), comprised of humpback whales, harbour porpoises, Dall’s porpoises, fin whales and killer whales, were observed while surveying along pre-determined transect lines. In addition, grey whales and minke whales were sighted in the survey area while “off-effort” (transiting between transect lines). 

Humpback whales were sighted during all seasons (`r all_ap_sf %>% filter(Species == "humpback whale") %>% nrow()` sightings comprised of `r sum(all_ap_sf[which(all_ap_sf$Species=="humpback whale"),]$Group_Size)` individuals); however, no individuals were observed while on-effort in February or March 2021 (Figure \@ref(fig:monthly-hw)). Peak detections occurred in early fall, and secondarily in summer. Winter humpback sightings primarily occurred in Juan de Fuca Strait while spring sightings were concentrated on Swiftsure Bank. The highest number and broadest distribution of humpback sightings occurred in October in both years.

Harbour porpoises were the most frequently sighted species of cetacean (`r all_ap_sf %>% filter(Species == "harbour porpoise") %>% nrow()` sightings, `r sum(all_ap_sf[which(all_ap_sf$Species=="harbour porpoise"),]$Group_Size)` individuals) and were detected during all surveys (all months January through November; Figure \@ref(fig:monthly-hp)). There were fewer sightings in late fall/ early winter, while the greatest number of sightings were in late summer/fall, with a second peak in spring. Most detections involved groups of 1-2 porpoises, but some larger group sizes were encountered including a sighting of approximately 45 individuals in April 2021 in southern Haro Strait. Harbour porpoise sightings were distributed throughout the study area, with greatest concentrations around Haro Strait, and were detected most months year-round throughout the southern Strait of Georgia, Boundary Pass and eastern Juan de Fuca Strait. Sightings of harbour porpoises decreased in western Juan de Fuca Strait and were rare on Swiftsure Bank.

Dall’s porpoises were encountered during all surveys though less frequently than harbour porpoises (`r all_ap_sf %>% filter(Species == "Dall's porpoise") %>% nrow()` sightings, `r sum(all_ap_sf[which(all_ap_sf$Species=="Dall's porpoise"),]$Group_Size)` individuals; Figure \@ref(fig:monthly-dp)). The highest numbers of Dall’s porpoise sightings were in the Strait of Georgia in fall and winter surveys.

Groups of southern resident and Bigg’s (transient) killer whales were encountered `r all_ap_sf %>% filter(Species == "killer whale - southern resident") %>% nrow() %>% english::as.english() %>% as.character()` and `r all_ap_sf %>% filter(Species == "killer whale - Bigg's") %>% nrow() %>% english::as.english() %>% as.character()` times, respectively, while on-effort. `r all_ap_sf %>% filter(Species == "killer whale - unknown ecotype") %>% nrow() %>% english::as.english() %>% as.character() %>% first_up()` groups of killer whales were sighted for which ecotype could not be determined, either because weather conditions prohibited the potential for photo-identification, or because breaking transect to collect identification photographs would have detracted from the primary objective of the survey (i.e. to cover the maximum extent of the survey area possible during each month).

Two single fin whales were sighted in summer in Juan de Fuca Strait (Figure \@ref(fig:plot-non-target)). Single minke whales were sighted on two occasions in southern Haro Strait. Grey whales were sighted on three occasions, two in western Juan de Fuca Strait and one in southern Haro Strait.

## DETECTION FUNCTIONS

Three species (humpback whales, harbour porpoises, and Dall’s porpoises) had sufficient sightings to fit detection functions. For each species, two or more models performed similarly in terms of AIC and goodness of fit. Comparisons of the top-performing models with delta AICs of less than five are presented in Tables \@ref(tab:df-tab-hw), \@ref(tab:df-tab-hp), and \@ref(tab:df-tab-dp).

The top performing detection functions for humpback whales included hazard-rate and half-normal key functions with visibility as a covariate, as well as a uniform key function with cosine adjustment terms of order 1, 2, and a hazard-rate key model with no covariates or series adjustments (Table \@ref(tab:df-tab-hw)). Two models had equal support: the hazard-rate model with visibility as a covariate and the uniform model, having nearly identical AIC scores and similar fit. Average detectability was slightly lower in the uniform model than in the hazard-rate model (0.44, compared to 0.49). The uniform model was selected because the added complexity of including the visibility covariate in the hazard-rate model did not improve model performance. Humpback whale sightings were right-truncated at a distance of 2 km. The resulting effective strip half-width (esw) for the selected model was 0.88 km (Figure \@ref(fig:plot-df-hw)a). Goodness of fit was visually assessed with Q-Q plots (Figure \@ref(fig:plot-df-hw)b).

The best-fitting detection functions for harbour porpoises were half-normal key functions with covariates of Beaufort sea state plus individual observer, or Beaufort alone (Table \@ref(tab:df-tab-hp)). Radial distances estimated by eye rather than calculated using binocular reticles were removed (n = 15) while fitting detection functions, as several of these sightings were estimated as falling directly on the trackline, contributing to some heaping of sightings at zero perpendicular distance. These sightings were returned to the dataset prior to abundance and density estimation. Harbour porpoise sightings were right-truncated at 0.7 km. The half-normal model with covariates of Beaufort and observer was selected, and had an esw of 0.41 km (Figure \@ref(fig:plot-df-hp)a). The distribution of perpendicular detection distances for each category of these covariates are presented in Figure \@ref(fig:violin-hp-bf) and Figure \@ref(fig:violin-hp-obs). Goodness of fit did not vary significantly among the top models (Table \@ref(tab:df-tab-hp)). Average detectability was equivalent among the models with delta AIC less than five.

The detection functions with the lowest AICs for Dall’s porpoises were half-normal key functions with the covariates glare, swell, glare plus swell, or no covariates (Table \@ref(tab:df-tab-dp)). Model averaging was considered but, with the exception of the hazard-rate models that included group size as a covariate, average detectability was very similar among models with delta AICs of less than five. The model with the lowest AIC was therefore selected, the half-normal key model with covariates of swell and glare (Figure \@ref(fig:plot-df-dp)). The relationship between covariates and perpendicular sighting distances are presented in Figure \@ref(fig:violin-dp-sw) and Figure \@ref(fig:violin-dp-gl). Sightings were right-truncated at a distance of 0.9 km and the esw was 0.44 km (Table \@ref(tab:df-tab-dp), Figure \@ref(fig:plot-df-dp)).

## SEASONAL ABUNDANCE ESTIMATES

Abundance and density were estimated seasonally for humpback whales, harbour porpoises, and Dall’s porpoises (Tables \@ref(tab:tab-ab-hw), \@ref(tab:tab-ab-hp), and \@ref(tab:tab-ab-dp)). Abundance is presented for the Canadian portion of the study area only (Figure \@ref(fig:plot-study-area); 2,938 km^2^). Density is presented per 25 km^2^ which was deemed an appropriate scale considering the size of the study area and the detection distances, and facilitates comparison with similar work (e.g. Wright et al., 2021).

Humpback whale estimated abundance was lowest in winter at 18 (CV: 0.36; 95% CI: 9 – 36) animals, significantly increasing through spring and summer to 84 (CV: 0.38; 95% CI: 40 – 174) and 96 (CV: 0.31; 95% CI: 52– 176) animals, respectively, to a peak in fall of 274 (CV: 0.28; 95% CI: 160 – 468; Table \@ref(tab:tab-ab-hw), Figure \@ref(fig:plot-ab)). 

Harbour porpoise estimated abundance was also lowest during winter at 584 (CV: 0.40; 95% CI: 274 – 1,242) animals, increasing through spring and summer to 915 (CV: 0.21; 95% CI: 603 – 1,387) and 1,089 (CV: 0.22; 95% CI: 709 – 1,674) animals, respectively, to its peak in fall of 1,430 (CV: 0.19; 95% CI: 986 – 2,073; Table \@ref(tab:tab-ab-hp), Figure \@ref(fig:plot-ab)). 

Dall’s porpoise seasonal abundance trends differed from those of the other two species (Table \@ref(tab:tab-ab-dp), Figure \@ref(fig:plot-ab)). Dall’s porpoise abundance peaked in winter, the season with lowest harbour porpoise abundance, with an estimated 362 (CV: 0.30; 95% CI: 203 – 643) animals. Estimated Dall’s porpoise abundance then dropped to 131 (CV: 0.39; 95% CI: 62 – 278) animals in spring while harbour porpoise abundance was increasing, and decreased further to 89 (CV: 0.48; 95% CI: 36 – 218) animals in summer. In fall, when harbour porpoise reached their peak abundance, Dall’s porpoise estimated abundance increased to 182 (CV: 0.36; 95% CI: 80 – 413) animals.


<!-- ```{r plot-ab, fig.cap = "Estimated seasonal abundance with the lower and upper bounds of a log-normal 95% confidence interval."} -->

<!--    -->
<!-- ``` -->

<!-- ```{r plot-ab-hw, fig.cap = "humpback whale abundance"} -->
<!-- plot_ab_hw <- ab_hw %<>% dplyr::select(Season, Abundance = N, L95.N, U95.N) %>%  -->
<!--   mutate(Species = "humpback whale") %>%  -->
<!--   mutate(Season=factor(Season, levels = levels(all_ap_sf$season))) -->

<!-- ggplot(plot_ab_hw, aes(Season, Abundance), colour = "black") + -->
<!--   geom_point(position=position_dodge(.9)) + -->
<!--   geom_errorbar(aes(ymin = L95.N, ymax = U95.N), width = 0.2, position=position_dodge(.9)) -->
<!-- ``` -->


```{r oct-hp-sgt}
### Compare same month of HP sightings in different years
# coast <- sf::st_read(dsn = "data", layer = "BC_coast_UTM9")
#
# #-----------------------------------------------------------
# sp <- "harbour porpoise"
# ap_sf <- all_ap_sf %>% filter(Species %like% sp)
#
# oct_hp <- all_ap_sf %>% filter(month == 10, Species == sp)
# oct_lines <- all_effort_lines %>% filter(month == 10)
#
# tx <- oct_hp %>% as.data.frame() %>%  dplyr::group_by(year) %>%
#   dplyr::summarise(N = n()) %>% as.data.frame()
#
# base_map +
#   geom_sf(data = oct_lines, stroke = 0.25, colour = "grey 40")+
#   geom_sf(data = oct_hp, stroke = 0.01, alpha = 0.5, aes(size = Count)) +#
#   scale_size_manual(values = c(1,1.5,2,3)) +
#   ggtitle(paste0("CeMoRe survey ", sp, " sightings Oct 2020 vs Oct 2021 ")) +
#   # annotation_custom(leg1Grob, xmin=-124.8, xmax=-124.95, ymin=47.9, ymax=48.1) +
#   coord +
#   facet_wrap(~year, drop = F) +
#     geom_text(data = tx, aes(x = (-124.4), y = 48.9, label = paste0("N = ", N, " sightings")), size = 2)

```

```{r jan-hp-sgt}
# jan_hp <- all_ap_sf %>% filter(month == 01, Species == sp)
# jan_lines <- all_effort_lines %>% filter(month == 01)
#
# tx <- jan_hp %>% as.data.frame() %>%  dplyr::group_by(year) %>%
#   dplyr::summarise(N = n()) %>% as.data.frame()
#
# base_map +
#   geom_sf(data = jan_lines, stroke = 0.25, colour = "grey 40")+
#   geom_sf(data = jan_hp, stroke = 0.01, alpha = 0.5, aes(size = Count)) +#
#   scale_size_manual(values = c(1,1.5,2,3)) +
#   ggtitle(paste0("CeMoRe survey ", sp, " sightings Jan 2021 vs Jan 2022 ")) +
#   # annotation_custom(leg1Grob, xmin=-124.8, xmax=-124.95, ymin=47.9, ymax=48.1) +
#   coord +
#   facet_wrap(~year, drop = F) +
#   geom_text(data = tx, aes(x = (-124.4), y = 48.9, label = paste0("N = ", N, " sightings")), size = 2)
```



